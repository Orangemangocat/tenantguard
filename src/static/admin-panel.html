<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TenantGuard Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-button { @apply px-4 py-2 text-gray-600 hover:text-gray-900 border-b-2 border-transparent cursor-pointer; }
        .tab-button.active { @apply text-blue-600 border-blue-600; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">TenantGuard Admin Panel</h1>
                    <p class="text-sm text-gray-500">Manage users, content, cases, and applications</p>
                </div>
                <div id="user-info" class="flex items-center space-x-4">
                    <div class="text-right">
                        <p id="user-name" class="text-sm font-medium text-gray-900"></p>
                        <p id="user-role" class="text-xs text-gray-500"></p>
                    </div>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex space-x-8">
                <button class="tab-button active" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="tab-button" onclick="switchTab('users')">Users</button>
                <button class="tab-button" onclick="switchTab('blog-posts')">Blog Posts</button>
                <button class="tab-button" onclick="switchTab('tenant-cases')">Tenant Cases</button>
                <button class="tab-button" onclick="switchTab('lawyer-apps')">Lawyer Applications</button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Total Users</h3>
                    <p id="stat-users" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Pending Blog Posts</h3>
                    <p id="stat-blog" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">New Tenant Cases</h3>
                    <p id="stat-cases" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Pending Lawyer Apps</h3>
                    <p id="stat-lawyers" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="tab-users" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-4">User Management</h2>
                    <div id="users-list"></div>
                </div>
            </div>
        </div>

        <!-- Blog Posts Tab -->
        <div id="tab-blog-posts" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-4">Blog Post Approval</h2>
                    <div id="blog-posts-list"></div>
                </div>
            </div>
        </div>

        <!-- Tenant Cases Tab -->
        <div id="tab-tenant-cases" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-4">Tenant Cases</h2>
                    <div id="tenant-cases-list"></div>
                </div>
            </div>
        </div>

        <!-- Lawyer Applications Tab -->
        <div id="tab-lawyer-apps" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-4">Lawyer Applications</h2>
                    <div id="lawyer-apps-list"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global state
        let authToken = null;
        let currentUser = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });

        function checkAuth() {
            authToken = localStorage.getItem('tenantguard_access_token');
            if (!authToken) {
                window.location.href = '/';
                return;
            }

            try {
                const payload = JSON.parse(atob(authToken.split('.')[1]));
                currentUser = payload;
                
                if (payload.role !== 'admin') {
                    alert('Admin access required');
                    window.location.href = '/';
                    return;
                }

                document.getElementById('user-name').textContent = payload.email || payload.name || 'Admin';
                document.getElementById('user-role').textContent = payload.role;

                loadDashboard();
            } catch (e) {
                console.error('Auth error:', e);
                window.location.href = '/';
            }
        }

        function logout() {
            localStorage.removeItem('tenantguard_access_token');
            localStorage.removeItem('tenantguard_refresh_token');
            localStorage.removeItem('tenantguard_authenticated');
            window.location.href = '/';
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            // Show selected tab
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            // Add active class to clicked button
            event.target.classList.add('active');

            // Load data for the tab
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'blog-posts':
                    loadBlogPosts();
                    break;
                case 'tenant-cases':
                    loadTenantCases();
                    break;
                case 'lawyer-apps':
                    loadLawyerApps();
                    break;
            }
        }

        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`/api/admin${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            return response.json();
        }

        async function loadDashboard() {
            try {
                const stats = await apiCall('/stats');
                document.getElementById('stat-users').textContent = stats.totalUsers || 0;
                document.getElementById('stat-blog').textContent = stats.pendingBlogPosts || 0;
                document.getElementById('stat-cases').textContent = stats.newTenantCases || 0;
                document.getElementById('stat-lawyers').textContent = stats.pendingLawyerApplications || 0;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadUsers() {
            try {
                const users = await apiCall('/users');
                const container = document.getElementById('users-list');
                container.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${users.map(user => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">${user.email}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">${user.role}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">${user.is_active ? 'Active' : 'Inactive'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button onclick="showEditUserModal(${user.id}, '${user.email}', '${user.full_name || ''}', '${user.role}')" class="text-blue-600 hover:text-blue-900 mr-2">
                                            Edit
                                        </button>
                                        <button onclick="toggleUserStatus(${user.id}, ${user.is_active})" class="text-green-600 hover:text-green-900 mr-2">
                                            ${user.is_active ? 'Deactivate' : 'Activate'}
                                        </button>
                                        <button onclick="deleteUser(${user.id}, '${user.email}')" class="text-red-600 hover:text-red-900">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadBlogPosts() {
            try {
                const posts = await apiCall('/blog-posts');
                const container = document.getElementById('blog-posts-list');
                container.innerHTML = `
                    <div class="space-y-4">
                        ${posts.map(post => `
                            <div class="border rounded-lg p-4">
                                <h3 class="font-bold text-lg">${post.title}</h3>
                                <p class="text-sm text-gray-600 mt-2">${post.content.substring(0, 200)}...</p>
                                <div class="mt-4 flex flex-wrap gap-2">
                                    <span class="px-2 py-1 text-xs rounded ${post.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : post.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${post.status}
                                    </span>
                                    <button onclick="showEditBlogModal(${post.id}, '${post.title.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${(post.content || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, '\\n')}', '${(post.excerpt || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                        Edit
                                    </button>
                                    ${post.status === 'pending' ? `
                                        <button onclick="approveBlogPost(${post.id})" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                            Approve
                                        </button>
                                        <button onclick="rejectBlogPost(${post.id})" class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                            Reject
                                        </button>
                                    ` : ''}
                                    ${post.status === 'published' ? `
                                        <button onclick="unpublishBlogPost(${post.id})" class="px-3 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700">
                                            Unpublish
                                        </button>
                                    ` : ''}
                                    ${post.status === 'draft' || post.status === 'approved' ? `
                                        <button onclick="publishBlogPost(${post.id})" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                            Publish
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteBlogPost(${post.id}, '${post.title.replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading blog posts:', error);
            }
        }

        async function loadTenantCases() {
            try {
                const cases = await apiCall('/tenant-cases');
                const container = document.getElementById('tenant-cases-list');
                container.innerHTML = `
                    <div class="space-y-4">
                        ${cases.map(c => `
                            <div class="border rounded-lg p-4">
                                <div class="flex justify-between">
                                    <h3 class="font-bold text-lg">${c.tenant_name}</h3>
                                    <span class="px-2 py-1 text-xs rounded ${c.urgency === 'high' ? 'bg-red-100 text-red-800' : c.urgency === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                        ${c.urgency} priority
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 mt-2"><strong>Issue:</strong> ${c.issue_type}</p>
                                <p class="text-sm text-gray-600"><strong>Description:</strong> ${c.description}</p>
                                <p class="text-sm text-gray-600"><strong>Status:</strong> ${c.status}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading tenant cases:', error);
            }
        }

        async function loadLawyerApps() {
            try {
                const apps = await apiCall('/lawyer-applications');
                const container = document.getElementById('lawyer-apps-list');
                container.innerHTML = `
                    <div class="space-y-4">
                        ${apps.map(app => `
                            <div class="border rounded-lg p-4">
                                <div class="flex justify-between">
                                    <h3 class="font-bold text-lg">${app.full_name}</h3>
                                    <span class="px-2 py-1 text-xs rounded ${app.status === 'pending_review' ? 'bg-yellow-100 text-yellow-800' : app.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${app.status}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 mt-2"><strong>Email:</strong> ${app.email}</p>
                                <p class="text-sm text-gray-600"><strong>Bar Number:</strong> ${app.bar_number}</p>
                                <p class="text-sm text-gray-600"><strong>Practice Areas:</strong> ${app.practice_areas}</p>
                                ${app.status === 'pending_review' ? `
                                    <div class="mt-4 flex space-x-2">
                                        <button onclick="approveLawyer(${app.id})" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                            Approve
                                        </button>
                                        <button onclick="rejectLawyer(${app.id})" class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                            Reject
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading lawyer applications:', error);
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            try {
                await apiCall(`/users/${userId}/toggle-active`, {
                    method: 'PUT',
                    body: JSON.stringify({ isActive: !currentStatus })
                });
                loadUsers();
            } catch (error) {
                alert('Error updating user status');
            }
        }

        async function approveBlogPost(postId) {
            try {
                await apiCall(`/blog-posts/${postId}/approve`, { method: 'PUT' });
                loadBlogPosts();
            } catch (error) {
                alert('Error approving blog post');
            }
        }

        async function rejectBlogPost(postId) {
            const reason = prompt('Rejection reason:');
            if (!reason) return;
            try {
                await apiCall(`/blog-posts/${postId}/reject`, {
                    method: 'PUT',
                    body: JSON.stringify({ reason })
                });
                loadBlogPosts();
            } catch (error) {
                alert('Error rejecting blog post');
            }
        }

        async function approveLawyer(appId) {
            try {
                await apiCall(`/lawyer-applications/${appId}/approve`, { method: 'PUT' });
                loadLawyerApps();
            } catch (error) {
                alert('Error approving lawyer application');
            }
        }

        async function rejectLawyer(appId) {
            const reason = prompt('Rejection reason:');
            if (!reason) return;
            try {
                await apiCall(`/lawyer-applications/${appId}/reject`, {
                    method: 'PUT',
                    body: JSON.stringify({ reason })
                });
                loadLawyerApps();
            } catch (error) {
                alert('Error rejecting lawyer application');
            }
        }
        // User Edit Modal Functions
        function showEditUserModal(userId, email, fullName, role) {
            document.getElementById('edit-user-id').value = userId;
            document.getElementById('edit-user-email').value = email || '';
            document.getElementById('edit-user-name').value = fullName || '';
            document.getElementById('edit-user-role').value = role || 'user';
            document.getElementById('edit-user-modal').classList.remove('hidden');
        }

        function closeEditUserModal() {
            document.getElementById('edit-user-modal').classList.add('hidden');
        }

        async function saveUserEdit() {
            const userId = document.getElementById('edit-user-id').value;
            const email = document.getElementById('edit-user-email').value;
            const fullName = document.getElementById('edit-user-name').value;
            const role = document.getElementById('edit-user-role').value;

            try {
                await apiCall(`/users/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ email, full_name: fullName, role })
                });
                closeEditUserModal();
                loadUsers();
                alert('User updated successfully');
            } catch (error) {
                alert('Error updating user: ' + error.message);
            }
        }

        async function deleteUser(userId, email) {
            if (!confirm(`Are you sure you want to delete user ${email}? This cannot be undone.`)) {
                return;
            }
            try {
                await apiCall(`/users/${userId}`, { method: 'DELETE' });
                loadUsers();
                alert('User deleted successfully');
            } catch (error) {
                alert('Error deleting user: ' + error.message);
            }
        }

        // Blog Post Edit Modal Functions
        function showEditBlogModal(postId, title, content, excerpt) {
            document.getElementById('edit-blog-id').value = postId;
            document.getElementById('edit-blog-title').value = title || '';
            document.getElementById('edit-blog-content').value = content || '';
            document.getElementById('edit-blog-excerpt').value = excerpt || '';
            document.getElementById('edit-blog-modal').classList.remove('hidden');
        }

        function closeEditBlogModal() {
            document.getElementById('edit-blog-modal').classList.add('hidden');
        }

        async function saveBlogEdit() {
            const postId = document.getElementById('edit-blog-id').value;
            const title = document.getElementById('edit-blog-title').value;
            const content = document.getElementById('edit-blog-content').value;
            const excerpt = document.getElementById('edit-blog-excerpt').value;

            try {
                await apiCall(`/blog-posts/${postId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ title, content, excerpt })
                });
                closeEditBlogModal();
                loadBlogPosts();
                alert('Blog post updated successfully');
            } catch (error) {
                alert('Error updating blog post: ' + error.message);
            }
        }

        async function publishBlogPost(postId) {
            try {
                await apiCall(`/blog-posts/${postId}/publish`, { method: 'PUT' });
                loadBlogPosts();
                alert('Blog post published successfully');
            } catch (error) {
                alert('Error publishing blog post: ' + error.message);
            }
        }

        async function unpublishBlogPost(postId) {
            try {
                await apiCall(`/blog-posts/${postId}/unpublish`, { method: 'PUT' });
                loadBlogPosts();
                alert('Blog post unpublished successfully');
            } catch (error) {
                alert('Error unpublishing blog post: ' + error.message);
            }
        }

        async function deleteBlogPost(postId, title) {
            if (!confirm(`Are you sure you want to delete "${title}"? This cannot be undone.`)) {
                return;
            }
            try {
                await apiCall(`/blog-posts/${postId}`, { method: 'DELETE' });
                loadBlogPosts();
                alert('Blog post deleted successfully');
            } catch (error) {
                alert('Error deleting blog post: ' + error.message);
            }
        }
    </script>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-bold mb-4">Edit User</h3>
            <input type="hidden" id="edit-user-id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="edit-user-email" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                <input type="text" id="edit-user-name" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                <select id="edit-user-role" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="user">User</option>
                    <option value="editor">Editor</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeEditUserModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
                <button onclick="saveUserEdit()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Edit Blog Post Modal -->
    <div id="edit-blog-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-bold mb-4">Edit Blog Post</h3>
            <input type="hidden" id="edit-blog-id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                <input type="text" id="edit-blog-title" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Excerpt</label>
                <textarea id="edit-blog-excerpt" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Content</label>
                <textarea id="edit-blog-content" rows="10" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeEditBlogModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
                <button onclick="saveBlogEdit()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
</body>
</html>
