<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TenantGuard Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-button { @apply px-4 py-2 text-gray-600 hover:text-gray-900 border-b-2 border-transparent cursor-pointer; }
        .tab-button.active { @apply text-blue-600 border-blue-600; }
        .hidden { display: none !important; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background: white; border-radius: 0.5rem; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">TenantGuard Admin Panel</h1>
                    <p class="text-sm text-gray-500">Manage users, content, cases, and applications</p>
                </div>
                <div id="user-info" class="flex items-center space-x-4">
                    <div class="text-right">
                        <p id="user-name" class="text-sm font-medium text-gray-900"></p>
                        <p id="user-role" class="text-xs text-gray-500"></p>
                    </div>
                    <a href="/" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Back to Site</a>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex space-x-8">
                <button class="tab-button active" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="tab-button" onclick="switchTab('users')">Users</button>
                <button class="tab-button" onclick="switchTab('blog-posts')">Blog Posts</button>
                <button class="tab-button" onclick="switchTab('tenant-cases')">Tenant Cases</button>
                <button class="tab-button" onclick="switchTab('lawyer-apps')">Lawyer Applications</button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Total Users</h3>
                    <p id="stat-users" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Pending Blog Posts</h3>
                    <p id="stat-blog" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">New Tenant Cases</h3>
                    <p id="stat-cases" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Pending Lawyer Apps</h3>
                    <p id="stat-lawyers" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="tab-users" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">User Management</h2>
                        <button onclick="showCreateUserModal()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">+ Create User</button>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="user-search" placeholder="Search users..." class="w-full px-4 py-2 border rounded" onkeyup="searchUsers()">
                    </div>
                    <div id="users-list" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>

        <!-- Blog Posts Tab -->
        <div id="tab-blog-posts" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Blog Post Management</h2>
                        <button onclick="showCreateBlogPostModal()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">+ Create Post</button>
                    </div>
                    <div class="mb-4 flex gap-4">
                        <input type="text" id="blog-search" placeholder="Search posts..." class="flex-1 px-4 py-2 border rounded" onkeyup="searchBlogPosts()">
                        <select id="blog-status-filter" class="px-4 py-2 border rounded" onchange="filterBlogPosts()">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="pending">Pending</option>
                            <option value="published">Published</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div id="blog-posts-list" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>

        <!-- Tenant Cases Tab -->
        <div id="tab-tenant-cases" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-4">Tenant Cases</h2>
                    <div class="mb-4 flex gap-4">
                        <input type="text" id="case-search" placeholder="Search cases..." class="flex-1 px-4 py-2 border rounded" onkeyup="searchCases()">
                        <select id="case-status-filter" class="px-4 py-2 border rounded" onchange="filterCases()">
                            <option value="">All Status</option>
                            <option value="new">New</option>
                            <option value="pending">Pending</option>
                            <option value="reviewing">Reviewing</option>
                            <option value="assigned">Assigned</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <div id="tenant-cases-list" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>

        <!-- Lawyer Applications Tab -->
        <div id="tab-lawyer-apps" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-4">Lawyer Applications</h2>
                    <div class="mb-4 flex gap-4">
                        <input type="text" id="lawyer-search" placeholder="Search applications..." class="flex-1 px-4 py-2 border rounded" onkeyup="searchLawyerApps()">
                        <select id="lawyer-status-filter" class="px-4 py-2 border rounded" onchange="filterLawyerApps()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="pending_review">Pending Review</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div id="lawyer-apps-list" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals Container -->
    <div id="modals-container"></div>

    <script>
        const API_BASE = '/api/admin';
        let currentTab = 'dashboard';
        
        // Get auth token
        function getToken() {
            return localStorage.getItem('access_token');
        }
        
        // API helper
        async function apiCall(endpoint, method = 'GET', body = null) {
            const token = getToken();
            if (!token) {
                window.location.href = '/?login=required';
                return null;
            }
            
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                if (response.status === 401 || response.status === 403) {
                    alert('Session expired or access denied. Please login again.');
                    window.location.href = '/?login=required';
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { error: error.message };
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const token = getToken();
            if (!token) {
                window.location.href = '/?login=required';
                return;
            }
            
            // Decode token for user info
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                document.getElementById('user-name').textContent = payload.email || 'Admin';
                document.getElementById('user-role').textContent = payload.role || 'admin';
                
                if (payload.role !== 'admin') {
                    alert('Admin access required');
                    window.location.href = '/';
                    return;
                }
            } catch (e) {
                console.error('Token decode error:', e);
            }
            
            loadDashboard();
        });
        
        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            event.target.classList.add('active');
            
            switch(tab) {
                case 'dashboard': loadDashboard(); break;
                case 'users': loadUsers(); break;
                case 'blog-posts': loadBlogPosts(); break;
                case 'tenant-cases': loadTenantCases(); break;
                case 'lawyer-apps': loadLawyerApps(); break;
            }
        }
        
        // Logout
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/';
        }
        
        // Dashboard
        async function loadDashboard() {
            const stats = await apiCall('/stats');
            if (stats && !stats.error) {
                document.getElementById('stat-users').textContent = stats.totalUsers || 0;
                document.getElementById('stat-blog').textContent = stats.pendingBlogPosts || 0;
                document.getElementById('stat-cases').textContent = stats.newTenantCases || 0;
                document.getElementById('stat-lawyers').textContent = stats.pendingLawyerApplications || 0;
            }
        }
        
        // ==================== USERS ====================
        async function loadUsers(search = '') {
            const users = await apiCall(`/users${search ? `?search=${encodeURIComponent(search)}` : ''}`);
            if (!users || users.error) {
                document.getElementById('users-list').innerHTML = '<p class="text-red-500">Error loading users</p>';
                return;
            }
            
            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Full Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            users.forEach(user => {
                const isActive = user.is_active === 1 || user.is_active === true;
                html += `
                    <tr>
                        <td class="px-4 py-3 text-sm">${user.id}</td>
                        <td class="px-4 py-3 text-sm">${user.email || '-'}</td>
                        <td class="px-4 py-3 text-sm">${user.username || '-'}</td>
                        <td class="px-4 py-3 text-sm">${user.full_name || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            <select onchange="updateUserRole(${user.id}, this.value)" class="border rounded px-2 py-1 text-sm">
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                                <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>Editor</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <button onclick="toggleUserActive(${user.id}, ${!isActive})" 
                                class="px-2 py-1 rounded text-xs ${isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${isActive ? 'Active' : 'Disabled'}
                            </button>
                        </td>
                        <td class="px-4 py-3 text-sm space-x-1">
                            <button onclick="showEditUserModal(${user.id})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">Edit</button>
                            <button onclick="deleteUser(${user.id})" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('users-list').innerHTML = html;
        }
        
        function searchUsers() {
            const search = document.getElementById('user-search').value;
            loadUsers(search);
        }
        
        async function updateUserRole(userId, role) {
            const result = await apiCall(`/users/${userId}/role`, 'PUT', { role });
            if (result && result.success) {
                showNotification('Role updated successfully', 'success');
            } else {
                showNotification('Failed to update role', 'error');
                loadUsers();
            }
        }
        
        async function toggleUserActive(userId, isActive) {
            const result = await apiCall(`/users/${userId}/toggle-active`, 'PUT', { isActive });
            if (result && result.success) {
                showNotification(`User ${isActive ? 'enabled' : 'disabled'} successfully`, 'success');
                loadUsers();
            } else {
                showNotification('Failed to update user status', 'error');
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
            
            const result = await apiCall(`/users/${userId}`, 'DELETE');
            if (result && result.success) {
                showNotification('User deleted successfully', 'success');
                loadUsers();
            } else {
                showNotification('Failed to delete user', 'error');
            }
        }
        
        function showCreateUserModal() {
            const html = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">Create New User</h3>
                        <form onsubmit="createUser(event)">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Email *</label>
                                <input type="email" id="new-user-email" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Username *</label>
                                <input type="text" id="new-user-username" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Full Name</label>
                                <input type="text" id="new-user-fullname" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Role</label>
                                <select id="new-user-role" class="w-full px-3 py-2 border rounded">
                                    <option value="user">User</option>
                                    <option value="viewer">Viewer</option>
                                    <option value="editor">Editor</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Create</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('modals-container').innerHTML = html;
        }
        
        async function createUser(event) {
            event.preventDefault();
            const data = {
                email: document.getElementById('new-user-email').value,
                username: document.getElementById('new-user-username').value,
                full_name: document.getElementById('new-user-fullname').value,
                role: document.getElementById('new-user-role').value
            };
            
            const result = await apiCall('/users', 'POST', data);
            if (result && result.success) {
                showNotification('User created successfully', 'success');
                closeModal();
                loadUsers();
            } else {
                showNotification(result?.error || 'Failed to create user', 'error');
            }
        }
        
        async function showEditUserModal(userId) {
            const user = await apiCall(`/users/${userId}`);
            if (!user || user.error) {
                showNotification('Failed to load user', 'error');
                return;
            }
            
            const html = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">Edit User</h3>
                        <form onsubmit="updateUser(event, ${userId})">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Email</label>
                                <input type="email" id="edit-user-email" value="${user.email || ''}" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Username</label>
                                <input type="text" id="edit-user-username" value="${user.username || ''}" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Full Name</label>
                                <input type="text" id="edit-user-fullname" value="${user.full_name || ''}" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Role</label>
                                <select id="edit-user-role" class="w-full px-3 py-2 border rounded">
                                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                    <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                                    <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>Editor</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                </select>
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('modals-container').innerHTML = html;
        }
        
        async function updateUser(event, userId) {
            event.preventDefault();
            const data = {
                email: document.getElementById('edit-user-email').value,
                username: document.getElementById('edit-user-username').value,
                full_name: document.getElementById('edit-user-fullname').value,
                role: document.getElementById('edit-user-role').value
            };
            
            const result = await apiCall(`/users/${userId}`, 'PUT', data);
            if (result && result.success) {
                showNotification('User updated successfully', 'success');
                closeModal();
                loadUsers();
            } else {
                showNotification(result?.error || 'Failed to update user', 'error');
            }
        }
        
        // ==================== BLOG POSTS ====================
        async function loadBlogPosts(search = '', status = '') {
            let url = '/blog-posts?';
            if (search) url += `search=${encodeURIComponent(search)}&`;
            if (status) url += `status=${encodeURIComponent(status)}`;
            
            const posts = await apiCall(url);
            if (!posts || posts.error) {
                document.getElementById('blog-posts-list').innerHTML = '<p class="text-red-500">Error loading posts</p>';
                return;
            }
            
            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Author</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            posts.forEach(post => {
                const statusColors = {
                    'draft': 'bg-gray-100 text-gray-800',
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'published': 'bg-green-100 text-green-800',
                    'rejected': 'bg-red-100 text-red-800'
                };
                const statusColor = statusColors[post.status] || 'bg-gray-100 text-gray-800';
                
                html += `
                    <tr>
                        <td class="px-4 py-3 text-sm">${post.id}</td>
                        <td class="px-4 py-3 text-sm max-w-xs truncate">${post.title || '-'}</td>
                        <td class="px-4 py-3 text-sm">${post.author || '-'}</td>
                        <td class="px-4 py-3 text-sm">${post.category || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded text-xs ${statusColor}">${post.status || 'draft'}</span>
                        </td>
                        <td class="px-4 py-3 text-sm">${post.created_at ? new Date(post.created_at).toLocaleDateString() : '-'}</td>
                        <td class="px-4 py-3 text-sm space-x-1">
                            <button onclick="showEditBlogPostModal(${post.id})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">Edit</button>
                            ${post.status === 'published' 
                                ? `<button onclick="unpublishBlogPost(${post.id})" class="px-2 py-1 bg-yellow-500 text-white rounded text-xs hover:bg-yellow-600">Unpublish</button>`
                                : `<button onclick="publishBlogPost(${post.id})" class="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">Publish</button>`
                            }
                            <button onclick="deleteBlogPost(${post.id})" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('blog-posts-list').innerHTML = html;
        }
        
        function searchBlogPosts() {
            const search = document.getElementById('blog-search').value;
            const status = document.getElementById('blog-status-filter').value;
            loadBlogPosts(search, status);
        }
        
        function filterBlogPosts() {
            searchBlogPosts();
        }
        
        async function publishBlogPost(postId) {
            const result = await apiCall(`/blog-posts/${postId}/publish`, 'PUT');
            if (result && result.success) {
                showNotification('Post published successfully', 'success');
                loadBlogPosts();
            } else {
                showNotification('Failed to publish post', 'error');
            }
        }
        
        async function unpublishBlogPost(postId) {
            const result = await apiCall(`/blog-posts/${postId}/unpublish`, 'PUT');
            if (result && result.success) {
                showNotification('Post unpublished successfully', 'success');
                loadBlogPosts();
            } else {
                showNotification('Failed to unpublish post', 'error');
            }
        }
        
        async function deleteBlogPost(postId) {
            if (!confirm('Are you sure you want to delete this blog post? This action cannot be undone.')) return;
            
            const result = await apiCall(`/blog-posts/${postId}`, 'DELETE');
            if (result && result.success) {
                showNotification('Post deleted successfully', 'success');
                loadBlogPosts();
            } else {
                showNotification('Failed to delete post', 'error');
            }
        }
        
        function showCreateBlogPostModal() {
            const html = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">Create New Blog Post</h3>
                        <form onsubmit="createBlogPost(event)">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Title *</label>
                                <input type="text" id="new-post-title" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Excerpt</label>
                                <input type="text" id="new-post-excerpt" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Content *</label>
                                <textarea id="new-post-content" required rows="6" class="w-full px-3 py-2 border rounded"></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Category</label>
                                <input type="text" id="new-post-category" class="w-full px-3 py-2 border rounded" value="general">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Author</label>
                                <input type="text" id="new-post-author" class="w-full px-3 py-2 border rounded" value="Admin">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Status</label>
                                <select id="new-post-status" class="w-full px-3 py-2 border rounded">
                                    <option value="draft">Draft</option>
                                    <option value="published">Published</option>
                                </select>
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Create</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('modals-container').innerHTML = html;
        }
        
        async function createBlogPost(event) {
            event.preventDefault();
            const data = {
                title: document.getElementById('new-post-title').value,
                excerpt: document.getElementById('new-post-excerpt').value,
                content: document.getElementById('new-post-content').value,
                category: document.getElementById('new-post-category').value,
                author: document.getElementById('new-post-author').value,
                status: document.getElementById('new-post-status').value
            };
            
            const result = await apiCall('/blog-posts', 'POST', data);
            if (result && result.success) {
                showNotification('Blog post created successfully', 'success');
                closeModal();
                loadBlogPosts();
            } else {
                showNotification(result?.error || 'Failed to create post', 'error');
            }
        }
        
        async function showEditBlogPostModal(postId) {
            const post = await apiCall(`/blog-posts/${postId}`);
            if (!post || post.error) {
                showNotification('Failed to load post', 'error');
                return;
            }
            
            const html = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">Edit Blog Post</h3>
                        <form onsubmit="updateBlogPost(event, ${postId})">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Title</label>
                                <input type="text" id="edit-post-title" value="${post.title || ''}" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Excerpt</label>
                                <input type="text" id="edit-post-excerpt" value="${post.excerpt || ''}" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Content</label>
                                <textarea id="edit-post-content" rows="6" class="w-full px-3 py-2 border rounded">${post.content || ''}</textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Category</label>
                                <input type="text" id="edit-post-category" value="${post.category || ''}" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('modals-container').innerHTML = html;
        }
        
        async function updateBlogPost(event, postId) {
            event.preventDefault();
            const data = {
                title: document.getElementById('edit-post-title').value,
                excerpt: document.getElementById('edit-post-excerpt').value,
                content: document.getElementById('edit-post-content').value,
                category: document.getElementById('edit-post-category').value
            };
            
            const result = await apiCall(`/blog-posts/${postId}`, 'PUT', data);
            if (result && result.success) {
                showNotification('Post updated successfully', 'success');
                closeModal();
                loadBlogPosts();
            } else {
                showNotification(result?.error || 'Failed to update post', 'error');
            }
        }
        
        // ==================== TENANT CASES ====================
        async function loadTenantCases(search = '', status = '') {
            let url = '/tenant-cases?';
            if (search) url += `search=${encodeURIComponent(search)}&`;
            if (status) url += `status=${encodeURIComponent(status)}`;
            
            const cases = await apiCall(url);
            if (!cases || cases.error) {
                document.getElementById('tenant-cases-list').innerHTML = '<p class="text-red-500">Error loading cases</p>';
                return;
            }
            
            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Case #</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tenant</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Issue Type</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Urgency</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            cases.forEach(c => {
                const urgencyColors = {
                    'low': 'bg-gray-100 text-gray-800',
                    'medium': 'bg-yellow-100 text-yellow-800',
                    'high': 'bg-orange-100 text-orange-800',
                    'critical': 'bg-red-100 text-red-800'
                };
                const urgencyColor = urgencyColors[c.urgency_level] || 'bg-gray-100 text-gray-800';
                
                html += `
                    <tr>
                        <td class="px-4 py-3 text-sm">${c.id}</td>
                        <td class="px-4 py-3 text-sm">${c.case_number || '-'}</td>
                        <td class="px-4 py-3 text-sm">${c.tenant_name || '-'}</td>
                        <td class="px-4 py-3 text-sm">${c.email || '-'}</td>
                        <td class="px-4 py-3 text-sm">${c.issue_type || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded text-xs ${urgencyColor}">${c.urgency_level || '-'}</span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <select onchange="updateCaseStatus(${c.id}, this.value)" class="border rounded px-2 py-1 text-sm">
                                <option value="new" ${c.status === 'new' ? 'selected' : ''}>New</option>
                                <option value="pending" ${c.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="reviewing" ${c.status === 'reviewing' ? 'selected' : ''}>Reviewing</option>
                                <option value="assigned" ${c.status === 'assigned' ? 'selected' : ''}>Assigned</option>
                                <option value="in_progress" ${c.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                <option value="resolved" ${c.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                <option value="closed" ${c.status === 'closed' ? 'selected' : ''}>Closed</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 text-sm space-x-1">
                            <button onclick="showCaseDetailsModal(${c.id})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">View</button>
                            <button onclick="deleteTenantCase(${c.id})" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('tenant-cases-list').innerHTML = html;
        }
        
        function searchCases() {
            const search = document.getElementById('case-search').value;
            const status = document.getElementById('case-status-filter').value;
            loadTenantCases(search, status);
        }
        
        function filterCases() {
            searchCases();
        }
        
        async function updateCaseStatus(caseId, status) {
            const result = await apiCall(`/tenant-cases/${caseId}/status`, 'PUT', { status });
            if (result && result.success) {
                showNotification('Case status updated', 'success');
            } else {
                showNotification('Failed to update status', 'error');
                loadTenantCases();
            }
        }
        
        async function deleteTenantCase(caseId) {
            if (!confirm('Are you sure you want to delete this case? This action cannot be undone.')) return;
            
            const result = await apiCall(`/tenant-cases/${caseId}`, 'DELETE');
            if (result && result.success) {
                showNotification('Case deleted successfully', 'success');
                loadTenantCases();
            } else {
                showNotification('Failed to delete case', 'error');
            }
        }
        
        async function showCaseDetailsModal(caseId) {
            const c = await apiCall(`/tenant-cases/${caseId}`);
            if (!c || c.error) {
                showNotification('Failed to load case details', 'error');
                return;
            }
            
            const html = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">Case Details - ${c.case_number || 'N/A'}</h3>
                        <div class="space-y-3">
                            <div><strong>Tenant:</strong> ${c.tenant_name || '-'}</div>
                            <div><strong>Email:</strong> ${c.email || '-'}</div>
                            <div><strong>Phone:</strong> ${c.phone || '-'}</div>
                            <div><strong>Property Address:</strong> ${c.rental_address || '-'}</div>
                            <div><strong>Issue Type:</strong> ${c.issue_type || '-'}</div>
                            <div><strong>Urgency:</strong> ${c.urgency_level || '-'}</div>
                            <div><strong>Status:</strong> ${c.status || '-'}</div>
                            <div><strong>Created:</strong> ${c.created_at ? new Date(c.created_at).toLocaleString() : '-'}</div>
                            <div><strong>Description:</strong></div>
                            <div class="bg-gray-100 p-3 rounded text-sm">${c.issue_description || 'No description provided'}</div>
                        </div>
                        <div class="flex justify-end mt-4">
                            <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modals-container').innerHTML = html;
        }
        
        // ==================== LAWYER APPLICATIONS ====================
        async function loadLawyerApps(search = '', status = '') {
            let url = '/lawyer-applications?';
            if (search) url += `search=${encodeURIComponent(search)}&`;
            if (status) url += `status=${encodeURIComponent(status)}`;
            
            const apps = await apiCall(url);
            if (!apps || apps.error) {
                document.getElementById('lawyer-apps-list').innerHTML = '<p class="text-red-500">Error loading applications</p>';
                return;
            }
            
            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bar #</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">State</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Experience</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            apps.forEach(app => {
                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'pending_review': 'bg-yellow-100 text-yellow-800',
                    'approved': 'bg-green-100 text-green-800',
                    'rejected': 'bg-red-100 text-red-800'
                };
                const statusColor = statusColors[app.status] || 'bg-gray-100 text-gray-800';
                
                html += `
                    <tr>
                        <td class="px-4 py-3 text-sm">${app.id}</td>
                        <td class="px-4 py-3 text-sm">${app.full_name || '-'}</td>
                        <td class="px-4 py-3 text-sm">${app.email || '-'}</td>
                        <td class="px-4 py-3 text-sm">${app.bar_number || '-'}</td>
                        <td class="px-4 py-3 text-sm">${app.bar_state || '-'}</td>
                        <td class="px-4 py-3 text-sm">${app.years_experience || '-'} yrs</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded text-xs ${statusColor}">${app.status || 'pending'}</span>
                        </td>
                        <td class="px-4 py-3 text-sm space-x-1">
                            <button onclick="showLawyerAppDetailsModal(${app.id})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">View</button>
                            ${app.status !== 'approved' ? `<button onclick="approveLawyerApp(${app.id})" class="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">Approve</button>` : ''}
                            ${app.status !== 'rejected' ? `<button onclick="showRejectLawyerAppModal(${app.id})" class="px-2 py-1 bg-yellow-500 text-white rounded text-xs hover:bg-yellow-600">Reject</button>` : ''}
                            <button onclick="deleteLawyerApp(${app.id})" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('lawyer-apps-list').innerHTML = html;
        }
        
        function searchLawyerApps() {
            const search = document.getElementById('lawyer-search').value;
            const status = document.getElementById('lawyer-status-filter').value;
            loadLawyerApps(search, status);
        }
        
        function filterLawyerApps() {
            searchLawyerApps();
        }
        
        async function approveLawyerApp(appId) {
            if (!confirm('Are you sure you want to approve this lawyer application?')) return;
            
            const result = await apiCall(`/lawyer-applications/${appId}/approve`, 'PUT');
            if (result && result.success) {
                showNotification('Application approved successfully', 'success');
                loadLawyerApps();
            } else {
                showNotification('Failed to approve application', 'error');
            }
        }
        
        function showRejectLawyerAppModal(appId) {
            const html = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">Reject Application</h3>
                        <form onsubmit="rejectLawyerApp(event, ${appId})">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Rejection Reason</label>
                                <textarea id="reject-reason" rows="4" class="w-full px-3 py-2 border rounded" placeholder="Enter reason for rejection..."></textarea>
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Reject</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('modals-container').innerHTML = html;
        }
        
        async function rejectLawyerApp(event, appId) {
            event.preventDefault();
            const reason = document.getElementById('reject-reason').value;
            
            const result = await apiCall(`/lawyer-applications/${appId}/reject`, 'PUT', { reason });
            if (result && result.success) {
                showNotification('Application rejected', 'success');
                closeModal();
                loadLawyerApps();
            } else {
                showNotification('Failed to reject application', 'error');
            }
        }
        
        async function deleteLawyerApp(appId) {
            if (!confirm('Are you sure you want to delete this application? This action cannot be undone.')) return;
            
            const result = await apiCall(`/lawyer-applications/${appId}`, 'DELETE');
            if (result && result.success) {
                showNotification('Application deleted successfully', 'success');
                loadLawyerApps();
            } else {
                showNotification('Failed to delete application', 'error');
            }
        }
        
        async function showLawyerAppDetailsModal(appId) {
            const app = await apiCall(`/lawyer-applications/${appId}`);
            if (!app || app.error) {
                showNotification('Failed to load application details', 'error');
                return;
            }
            
            const html = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">Lawyer Application Details</h3>
                        <div class="space-y-3">
                            <div><strong>Name:</strong> ${app.full_name || '-'}</div>
                            <div><strong>Email:</strong> ${app.email || '-'}</div>
                            <div><strong>Phone:</strong> ${app.phone || '-'}</div>
                            <div><strong>Bar Number:</strong> ${app.bar_number || '-'}</div>
                            <div><strong>Bar State:</strong> ${app.bar_state || '-'}</div>
                            <div><strong>Years of Experience:</strong> ${app.years_experience || '-'}</div>
                            <div><strong>Firm Name:</strong> ${app.firm_name || '-'}</div>
                            <div><strong>Firm Address:</strong> ${app.firm_address || '-'}</div>
                            <div><strong>Specializations:</strong> ${app.specializations || '-'}</div>
                            <div><strong>Status:</strong> ${app.status || '-'}</div>
                            <div><strong>Applied:</strong> ${app.application_date ? new Date(app.application_date).toLocaleString() : '-'}</div>
                            ${app.reviewer_notes ? `<div><strong>Reviewer Notes:</strong> ${app.reviewer_notes}</div>` : ''}
                        </div>
                        <div class="flex justify-end mt-4 gap-2">
                            ${app.status !== 'approved' ? `<button onclick="closeModal();approveLawyerApp(${app.id})" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Approve</button>` : ''}
                            ${app.status !== 'rejected' ? `<button onclick="closeModal();showRejectLawyerAppModal(${app.id})" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Reject</button>` : ''}
                            <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modals-container').innerHTML = html;
        }
        
        // ==================== UTILITIES ====================
        function closeModal() {
            document.getElementById('modals-container').innerHTML = '';
        }
        
        function showNotification(message, type = 'info') {
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded text-white ${colors[type]} shadow-lg z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>
</html>
